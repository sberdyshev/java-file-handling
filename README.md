# Курсовой проект
Клиент-серверное сетевое хранилице.

## 0. Оглавление
- [1. Требования](#1-требования)
  - [1.1. Требования для MVP](#11-требования-для-mvp)
    - [1.1.1. Функциональные требования для MVP](#111-функциональные-требования-для-mvp)
    - [1.1.2. Нефункциональные требования для MVP](#112-нефункциональные-требования-для-mvp)
    - [1.1.3. Технические ограничения](#113-технические-ограничения)
  - [1.2. Опциональные требования](#12-опциональные-требования)
    - [1.2.1. Опциональные функциональные требования](#121-опциональные-функциональные-требования)
    - [1.2.2. Опциональные нефункциональные требования](#122-опциональные-нефункциональные-требования)
- [2. Реализация](#2-реализация)
  - [2.1. MVP](#21-mvp)
    - [2.1.1. Архитектура](#211-архитектура)
      - [2.1.1.1. Модули системы](#2111-модули-системы)
      - [2.1.1.2. Технологический стек MVP](#2112-технологический-стек-mvp)
      - [2.1.1.3. Интеграция клиентской и серверной части](#2113-интеграция-клиентской-и-серверной-части)
      - [2.1.1.4. Реализация клиентской части](#2114-реализация-клиентской-части)
      - [2.1.1.5. Релизация аутентификации](#2115-релизация-аутентификации)
      - [2.1.1.6. Ограничения и политика решения](#2116-ограничения-и-политика-решения)
    - [2.1.2. Реализация функциональных требований](#212-реализация-функциональных-требований)
      - [2.1.2.1. Формат команд для обращения к серверу](#2121-формат-команд-для-обращения-к-серверу)
        - [2.1.2.1.1. Разрешенные типы команд для обращения к серверу](21211-разрешенные-типы-команд-для-обращения-к-серверу)
      - [2.1.2.2. Аутентификация](#2122-аутентификация)
        - [2.1.2.2.1. Формат команды аутентификации](21221-формат-команды-аутентификации)
      - [2.1.2.3. Удаление файла с сервера](#2123-удаление-файла-с-сервера)
        - [2.1.2.3.1. Формат команды "удаление файла с сервера"](21231-формат-команды-удаление-файла-с-сервера)
      - [2.1.2.4. Получение файла с сервера](#2124-получение-файла-с-сервера)
          - [2.1.2.4.1. Формат команды "получение файла с сервера"](#21241-формат-команды-получение-файла-с-сервера)
      - [2.1.2.5. Получение списка файлов с сервера](#2125-получение-списка-файлов-с-сервера)
        - [2.1.2.5.1. Формат команды "получение списка файлов с сервера"](#21251-формат-команды-получение-списка-файлов-с-сервера)
      - [2.1.2.6. Запись файла на сервер](#2126-запись-файла-на-сервер)
        - [2.1.2.6.1. Формат команды "запись файла на сервер"](#21261-формат-команды-запись-файла-на-сервер)

## 1. Требования
### 1.1. Требования для MVP
#### 1.1.1. Функциональные требования для MVP
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

1. Подключение клиента к серверу
2. Выполняемые операции:
   - Отправка файлов на сервер
   - Скачивание файлов
   - Получение списка файлов на сервере
   - Удаление файлов на сервере
   - Удаление файлов на клиенте
3. Клиентская часть имеет графический интерфейс (толстый клиент) или имеет консольное управление
4. Все будет работать на сокетах
5. Все файлы хранятся в каталоге с именем пользователя. Реализация вложенных каталогов не нужна.

#### 1.1.2. Нефункциональные требования для MVP
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

1. Аутентификация
2. Авторизация и ролевой доступ
   - Клиенты выполняют действия только над своими файлами

#### 1.1.3. Технические ограничения
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

1. Взаимодействия между клиентом и сервером на сокетах
2. При выборе графического интерфейса для клиента он должен быть реализован на JavaFX

### 1.2. Опциональные требования
#### 1.2.1. Опциональные функциональные требования
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

1. Докачка файлов в случае остановки передачи или сбоя
2. Sharing файлов. Пользователи должны иметь возможность передачи прав на свои файлы другим пользователям:
   - На удаление на сервере
   - На скачивание
   - На получение списка
   - На запись новых файлов на сервер
3. Проверка целостности данных
4. Прогресс загрузки файла

#### 1.2.2. Опциональные нефункциональные требования
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

1. Шифрование

## 2. Реализация
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Планируется микросервисная архитектура. Микросервисная архитектура не подходит для решения задач подобного плана (объем и тип решения), т.к. требует временных вложений больше, чем сама задача. Но она выбрана в учебных целях.

В MVP будет реализован минимальный функционал с ограниченными или отсутствующими инраструктурными решениями или сервисами. При наличии времени, функциональнал будет расширяться. Шаги расширения описаны после раздела MVP.

*Архитектура не является финальной и будет уточняться по мере необходимости.*

### 2.1. MVP
#### 2.1.1. Архитектура
##### 2.1.1.1. Модули системы
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Мы имеем один домен, один bounded context.
Функционал сервера решено разделить на 4 микросервиса:
1. FileFetcher. Ответственнен за передачу клиенту файла и списка файлов на сервере.
2. FileCreator. Ответственен за создание файлов на сервере.
3. FileDeletor. Ответственен за удаление файлов с сервера.
4. AuthService. Ответственен за аутентификацию клиентов.

На реальной задаче микросервисы 1-3 были бы объединены в единый, здесь же разделение обусловлено целями обучения.

Файлы будут храниться в HDFS. HDFS отлично подходит для задач управления файлами. Альтерантивы не рассматривались в виду отсутствия времени.

Персональные данные будут храниться в специализированном ПО. В данный момент идет выбор между HashiCorp Vault и KeyCloak. Выбор зависит от способа аутентификации, которая так же еще не определена.

Модульная схема приложения:

![PlantUML model](http://www.plantuml.com/plantuml/png/3ScxjOCm303GLTuR0AjFoH3fZQLW9RBCqGTEjW_jlV-iJH8fJVvwnE4F0AjNsJbwRkbaRMgGHcbpW6za-FLE9xphMPSN2oszAWhh3gDwa07Evf13O4qMl6ELsJvFfgiSD_y0)

##### 2.1.1.2. Технологический стек MVP:
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

1. Java 1.8
2. JUnit
3. Jacoco
4. Maven5.
5. Slf4j, logback
6. Netty
6. Sonarqube
7. HDFS
8. HashiCorp Vault \ KeyCloak

##### 2.1.1.3. Интеграция клиентской и серверной части
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Взаимодействие между клиентом и серверов будет осуществляться по TCP соединению. Реализация планируется средствами Netty и NIO. Для обеспечения stateless реализации сервера каждый клиент будет держать одно соединение к серверной части. Тут есть риски. Т.к. передавать необходимо и большие файлы и управлящие команды с метаданными, то реализация единичного потока может потребовать парсинга всех входящих обращений для анализа, является ли оно командой (например, старт\стоп передачи файла) или частью файла. Более того, текстовое представление команд может потребовать использования BASE64 кодирования для записи потока байт файла в текстовое сообщение, что увеличит нагрузку на 30%. С другой стороны, поддержание двух соединений между клиентом и сервером предполагает хранение состоянии на серверной части, что ухудшит масштабируемость. Необходим дополнительный ресерч инструментов реализации - NIO\Netty, чтобы понять, возможна ли реализация в один поток.

##### 2.1.1.4. Реализация клиентской части
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Клиентская часть будет управляться через консольный ввод.

##### 2.1.1.5. Релизация аутентификации
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Клиентское приложение будет аутентифицироваться через AuthService. Т.к. архитектура предполагает несколько микросервисов, для исключения необходимости аутентификации при каждом обращении требуется реализация SSO. В качестве решения отлично подойдет использование JWT.
JWT предполагает обеспечение защиты токена от кражи при передаче и хранении. Этот функционал не фходит в MVP.

##### 2.1.1.6. Ограничения и политика решения
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Разрабатываемое приложение максимально близко соответствует [12 факторам.](https://12factor.net)

1. Каждый микросервис имеет свой репозиторий.
2. Зависимости управляются сборщиками
3. Конфигурация на уровне environment (не входит в MVP)
4. HDFS и SSO менеджер считаются подключенными ресурсами
5. Приложение предполагает автоматизированную сборку и тестирование (не входит в MVP)
6. Все процессы stateless между транзакциями
7. Порты будут экспортированы при помощи докера (не входит в MVP)
8. Отсутствие многопоточности. Обработка паралельной нагрузки предполагается за счет масштабирования процессов, не потоков.
9. Отсутствие хранимого состояния предполагает утилизируемость всех сервисов.
10. Журнилирование будет обрабатываться как потокок событий и не решаться на уровне приложения (не входит в MVP)

Решение будет покрыто тестами не менее, чем на 60%.

MVP не будет обеспечивать service discovery и балансировку запросов. Сетевые адреса будут вынесены в environment variables.

MVP в отношении инфраструктурных сервисов:
- будет обеспечивать журналирование в файлы на серверах
- не будет обеспечивать аудит
- не будет обеспечивать мониторинг
- не будет обеспечивать отказоусточивать
- будет разворачиваться "as is" в качестве процессов-демонов (за исключение клиентского приложения). Использование контейнеров и средств управления контейнерами в MVP не предусмотрено.

#### 2.1.2. Реализация функциональных требований
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Механизм реализации функциональных требований отражен на диаграммах последовательности ниже. Для упрощения документации диаграммы последовательности также содержат алгоритм реализации функциональных требований.

##### 2.1.2.1. Формат команд для обращения к серверу
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

В качестве формата выбран CSV. Формат представляет собой фиксированную по длине строку. Каждый аргумент отделяется от остальных запятыми и дополняется пробелами в начале на случай, если его длина оказалась меньше длины поля.

Общий формат:

Количество символов  | Обязательность поля | Описание
--|---|--
7  | Обязательное  |  константа "COMMAND"
15  | Обязательное  |  тип команды. Возможные значения указаны в разделе "[Разрешенные типы команд для обращения к серверу](#21211-разрешенные-типы-команд-для-обращения-к-серверу)".
20  |  Обязательное |  логин пользователя
20  | Зависит от комманды  |  пароль пользователя
6  |  Обязательное |  версия сервиса в формате Х.Y.Z.
20  | Зависит от комманды  |  имя файла
256  | Зависит от комманды  |  токен

>В теории имя файла должно содержать полные его путь. А это гораздо больше 20 символов. В MVP все файлы содержаться в корневом каталоге, поэтому пока закладываем на имя файла 20 символов

Примеры комманд (символы "*_*" и "*(256 пустых символов)*" должны быть заменены на пробелы; символы "*(токен)*" должны быть заменены на токен, дополненный при необходимости до 256 символов пробелами):

`"COMMAND,___AUTH_REQUEST,_______________anton,____________password,1.0.0.,____________________,(256 пустых символов)"`

`"COMMAND,____DELETE_FILE,_marina.panova@ya.ru,____________________,2.1.8.,____________file.txt,(токен)"`

###### 2.1.2.1.1. Разрешенные типы команд для обращения к серверу
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Команда  | Описание команды | Формат для передачи
--|--|--
Запрос на аутентификацию  | Аутентифицирует пользовательский клиент на сервере | AUTH_REQUEST
Создание файла  | Создает файл на сервере и наполняет его содержимым из локального пользовательского файла |  CREATE_FILE
Удаление файла  | Удаляет файл на сервере |  DELETE_FILE
Получение файла  | Получает файл с сервера и записывает его на локальную пользовательску файловую систему |  FETCH_FILE
Получение списка файлов  | Получает спискок файлов с сервера |   FETCH_FILE_LIST

##### 2.1.2.2. Аутентификация
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Схема механизма и алгоритма аутентификации:

![PlantUML model](http://www.plantuml.com/plantuml/png/BOuzai8m34RxFSLkiMKYXf8g1JVW18ejOZ6s7FGJXjiJ1ggl-DwyUPCvgaUhFtyigKQcqFfRt5Sx0IW-neMzn1n6cheuYO-fDx2PD3-jq0Ott72uSgMXeEJAia13SrB8FHdiRZ2w1qcY_-CXCowApG332ubpGkSkbozn_jpZ-awQIFA-Bm00)

###### 2.1.2.2.1. Формат команды аутентификации
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Количество символов  | Обязательность поля | Описание
--|---|--
7  | Обязательное  |  константа "COMMAND"
15  | Обязательное  |  тип команды. Заполняется значением "____AUTH_REQUEST"
20  |  Обязательное |  логин пользователя
20  | Обязательное  |  пароль пользователя
6  |  Обязательное |  версия сервиса в формате Х.Y.Z.
20  | Не заполняется  |  имя файла (будет проигнорировано)
256  | Не заполняется  |  токен (будет проигнорировано)

Пример (символы "*_*" и "*(256 пустых символов)*" должны быть заменены на пробелы; символы "*(токен)*" должны быть заменены на токен, дополненный при необходимости до 256 символов пробелами):

`"COMMAND,___AUTH_REQUEST,_______________anton,____________password,1.0.0.,____________________,(256 пустых символов)"`

##### 2.1.2.3. Удаление файла с сервера
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Схема механизма и алгоритма удаления файла с сервера:

![PlantUML model](http://www.plantuml.com/plantuml/png/BSun3i8m34RXdLF0mDWQCJ9rG5o04xZ9JnFaf2MsYxWz89ZUy2rlKEDcNcIpopM8HtYJRJ9Rz4JK-DbFsPAFhcXXhePgVPWBwOWMNvgmqfrNxcvPq2MkKNATgB0Q6iKvA7aHKZmSDM1_FCJCK-EY524mNBBW-jVpZ_hbkpEWna_V)

###### 2.1.2.3.1. Формат команды "удаление файла с сервера"
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Количество символов  | Обязательность поля | Описание
--|---|--
7  | Обязательное  |  константа "COMMAND"
15  | Обязательное  |  тип команды. Заполняется значением "_____DELETE_FILE"
20  |  Обязательное |  логин пользователя
20  | Не заполняется  |  пароль пользователя (будет проигнорировано)
6  |  Обязательное |  версия сервиса в формате Х.Y.Z.
20  | Обязательное  |  имя файла
256  | Обязательное  |  токен

Пример (символы "*_*" и "*(256 пустых символов)*" должны быть заменены на пробелы; символы "*(токен)*" должны быть заменены на токен, дополненный при необходимости до 256 символов пробелами):

`"COMMAND,____DELETE_FILE,_______________anton,____________________,1.0.0.,____________file.txt,(токен)"`

##### 2.1.2.4. Получение файла с сервера
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Схема механизма и алгоритма получения файла с сервера:

![PlantUML model](http://www.plantuml.com/plantuml/png/BSux3i8m40JGdbD0GPaiegHAWRW09zZOczZ8teJz175xZA2Qucb6CwYXcDUoEsGEnIEvb7qoM_K28FZgvsp9HrUIiB0HMn-M2ZgInBScsk216tPJBjGbv5Wopr1HZGJY4XJQDYWzdJZGyNoA6MV1gZ2HXNHhjViVhp_fr--RWJYs_000)

###### 2.1.2.4.1. Формат команды "получение файла с сервера"
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Количество символов  | Обязательность поля | Описание
--|---|--
7  | Обязательное  |  константа "COMMAND"
15  | Обязательное  |  тип команды. Заполняется значением "______FETCH_FILE"
20  |  Обязательное |  логин пользователя
20  | Не заполняется  |  пароль пользователя (будет проигнорировано)
6  |  Обязательное |  версия сервиса в формате Х.Y.Z.
20  | Обязательное  |  имя файла
256  | Обязательное  |  токен

Пример (символы "*_*" и "*(256 пустых символов)*" должны быть заменены на пробелы; символы "*(токен)*" должны быть заменены на токен, дополненный при необходимости до 256 символов пробелами):

`"COMMAND,_____FETCH_FILE,_______________anton,____________________,1.0.0.,____________file.txt,(токен)"`

##### 2.1.2.5. Получение списка файлов с сервера
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Схема механизма и алгоритма получения списка файлов с сервера:

![PlantUML model](http://www.plantuml.com/plantuml/png/BOwnhi8m34NtznMFWR4rOcJgW9ZO-08tSHkZn2csKyJVKmJJ7UxHqHdCKRsL_BTZ2Rb5Qfh_a_jY9m35Pp-pfpOs8mrLdCJxK0lOI1fVbcY5EwxOJPofIoWniynGq9mKOWq6cnkC7eqaqFvuY8opOZ6Oo4EwSAOhczz-mFdxzikdQ229sxu1)

###### 2.1.2.5.1. Формат команды "получение списка файлов с сервера"
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Количество символов  | Обязательность поля | Описание
--|---|--
7  | Обязательное  |  константа "COMMAND"
15  | Обязательное  |  тип команды. Заполняется значением "FETCH_FILE_LIST"
20  |  Обязательное |  логин пользователя
20  | Не заполняется  |  пароль пользователя (будет проигнорировано)
6  |  Обязательное |  версия сервиса в формате Х.Y.Z.
20  | Не заполняется  |  имя файла
256  | Обязательное  |  токен

Пример (символы "*_*" и "*(256 пустых символов)*" должны быть заменены на пробелы; символы "*(токен)*" должны быть заменены на токен, дополненный при необходимости до 256 символов пробелами):

`"COMMAND,FETCH_FILE_LIST,_______________anton,____________________,1.0.0.,____________________,(токен)"`

##### 2.1.2.6. Запись файла на сервер
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Схема механизма и алгоритма записи файла на сервер:

![PlantUML model](http://www.plantuml.com/plantuml/png/BSunhi8m40JG_f_YKr0cYoYfKY0km0aszX0RsPkmkmxYzWH1DSNJZ6OmP_LMozykIoWjecdvJ-wBdOYKd_sKFRMn6JJCuX3lmrp9HcXyMS9ATrwvk-M2Bh74acMYokPGYdCmshR9y6YGWFtn43DFojKeADXnsNhNdvw_r2-VEmCaRla6)

###### 2.1.2.6.1. Формат команды "запись файла на сервер"
<sub><sup> [К оглавлению.](#0-оглавление) </sup></sub><br/>

Количество символов  | Обязательность поля | Описание
--|---|--
7  | Обязательное  |  константа "COMMAND"
15  | Обязательное  |  тип команды. Заполняется значением "____CREATE_FILE"
20  |  Обязательное |  логин пользователя
20  | Не заполняется  |  пароль пользователя (будет проигнорировано)
6  |  Обязательное |  версия сервиса в формате Х.Y.Z.
20  | Не заполняется  |  имя файла
256  | Обязательное  |  токен

Пример (символы "*_*" и "*(256 пустых символов)*" должны быть заменены на пробелы; символы "*(токен)*" должны быть заменены на токен, дополненный при необходимости до 256 символов пробелами):

`"COMMAND,____CREATE_FILE,_______________anton,____________________,1.0.0.,____________file.txt,(токен)"`
